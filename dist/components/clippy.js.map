{"version":3,"sources":["../../src/components/clippy.js"],"names":["window","clippy","Agent","path","data","sounds","_queue","Queue","$","proxy","_onQueueEmpty","_el","hide","document","body","append","_animator","Animator","_balloon","Balloon","_setupEvents","prototype","gestureAt","x","y","d","_getDirection","gAnim","lookAnim","animation","hasAnimation","play","fast","callback","_hidden","el","stop","pause","_playInternal","moveTo","duration","dir","anim","undefined","_addToQueue","complete","css","top","left","reposition","animate","name","state","States","EXITED","WAITING","exitAnimation","_isIdleAnimation","_idleDfd","done","showAnimation","timeout","cb","completed","setTimeout","show","resume","width","height","scrollTop","speak","text","hold","closeBalloon","delay","time","stopCurrent","close","clear","animations","Math","floor","random","length","indexOf","offset","h","w","centerX","centerY","a","b","r","round","atan2","PI","idleAnim","_getIdleAnimation","Deferred","_onIdleComplete","resolve","c","currentAnimationName","i","push","idx","on","_onMouseDown","_onDoubleClick","is","o","bH","outerHeight","bW","outerWidth","wW","wH","sT","sL","scrollLeft","m","e","preventDefault","_startDrag","_offset","_calculateClickOffset","_moveHandle","_dragMove","_upHandle","_finishDrag","_dragUpdateLoop","_updateLocation","mouseX","pageX","mouseY","pageY","_targetY","_taregtX","clientX","clientY","clearTimeout","off","func","scope","queue","_data","_path","_currentFrameIndex","_currentFrame","_exiting","_currentAnimation","_endCallback","_started","_sounds","preloadSounds","_overlays","curr","_setupElement","overlayCount","inner","frameSize","framesize","n","snd","uri","Audio","animationName","stateChangeCallback","_step","_draw","images","xy","bg","_getNextAnimationFrame","currentFrame","branching","exitBranch","rnd","branches","branch","weight","frameIndex","_playSound","s","sound","audio","_atLastFrame","frames","newFrameIndex","min","frameChanged","useExitBranching","_loop","targetEl","_targetEl","_setup","WORD_SPEAK_TIME","CLOSE_BALLOON_DELAY","_content","find","sides","_position","_isOut","_BALLOON_MARGIN","side","removeClass","addClass","_complete","_sayWords","_hiding","_finishHideBalloon","_active","_hold","words","split","_addWord","slice","join","BASE_PATH","load","successCb","failCb","mapDfd","_loadMap","agentDfd","_loadAgent","soundsDfd","_loadSounds","when","fail","_maps","dfd","src","img","Image","onload","onerror","reject","setAttribute","promise","createElement","canPlayMp3","canPlayType","canPlayOgg","_loadScript","_getAgentDfd","script","head","appendChild","ready","soundsReady","onEmptyCallback","_onEmptyCallback","_progressQueue","f","shift","completeFunction","next","call"],"mappings":"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","file":"clippy.js","sourcesContent":["// thank you Smore for this wonderful script!\n// https://www.smore.com/clippy-js\n\n;(function() {\n\n    window.clippy = {};\n    /******\n     *\n     *\n     * @constructor\n     */\n    clippy.Agent = function (path, data, sounds) {\n        this.path = path;\n\n        this._queue = new clippy.Queue($.proxy(this._onQueueEmpty, this));\n\n        this._el = $('<div class=\"clippy\"></div>').hide();\n\n        $(document.body).append(this._el);\n\n        this._animator = new clippy.Animator(this._el, path, data, sounds);\n\n        this._balloon = new clippy.Balloon(this._el);\n\n        this._setupEvents();\n    };\n\n    clippy.Agent.prototype = {\n\n        /**************************** API ************************************/\n\n        /***\n         *\n         * @param {Number} x\n         * @param {Number} y\n         */\n        gestureAt:function (x, y) {\n            var d = this._getDirection(x, y);\n            var gAnim = 'Gesture' + d;\n            var lookAnim = 'Look' + d;\n\n            var animation = this.hasAnimation(gAnim) ? gAnim : lookAnim;\n            return this.play(animation);\n        },\n\n        /***\n         *\n         * @param {Boolean=} fast\n         *\n         */\n        hide:function (fast, callback) {\n            this._hidden = true;\n            var el = this._el;\n            this.stop();\n            if (fast) {\n                this._el.hide();\n                this.stop();\n                this.pause();\n                if (callback) callback();\n                return;\n            }\n\n            return this._playInternal('Hide', function () {\n                el.hide();\n                this.pause();\n                if (callback) callback();\n            })\n        },\n\n\n        moveTo:function (x, y, duration) {\n            var dir = this._getDirection(x, y);\n            var anim = 'Move' + dir;\n            if (duration === undefined) duration = 1000;\n\n            this._addToQueue(function (complete) {\n                // the simple case\n                if (duration === 0) {\n                    this._el.css({top:y, left:x});\n                    this.reposition();\n                    complete();\n                    return;\n                }\n\n                // no animations\n                if (!this.hasAnimation(anim)) {\n                    this._el.animate({top:y, left:x}, duration, complete);\n                    return;\n                }\n\n                var callback = $.proxy(function (name, state) {\n                    // when exited, complete\n                    if (state === clippy.Animator.States.EXITED) {\n                        complete();\n                    }\n                    // if waiting,\n                    if (state === clippy.Animator.States.WAITING) {\n                        this._el.animate({top:y, left:x}, duration, $.proxy(function () {\n                            // after we're done with the movement, do the exit animation\n                            this._animator.exitAnimation();\n                        }, this));\n                    }\n\n                }, this);\n\n                this._playInternal(anim, callback);\n            }, this);\n        },\n\n        _playInternal:function (animation, callback) {\n\n            // if we're inside an idle animation,\n            if (this._isIdleAnimation() && this._idleDfd && this._idleDfd.state() === 'pending') {\n                this._idleDfd.done($.proxy(function () {\n                    this._playInternal(animation, callback);\n                }, this))\n            }\n\n            this._animator.showAnimation(animation, callback);\n        },\n\n        play:function (animation, timeout, cb) {\n            if (!this.hasAnimation(animation)) return false;\n\n            if (timeout === undefined) timeout = 5000;\n\n\n            this._addToQueue(function (complete) {\n                var completed = false;\n                // handle callback\n                var callback = function (name, state) {\n                    if (state === clippy.Animator.States.EXITED) {\n                        completed = true;\n                        if (cb) cb();\n                        complete();\n                    }\n                };\n\n                // if has timeout, register a timeout function\n                if (timeout) {\n                    window.setTimeout($.proxy(function () {\n                        if (completed) return;\n                        // exit after timeout\n                        this._animator.exitAnimation();\n                    }, this), timeout)\n                }\n\n                this._playInternal(animation, callback);\n            }, this);\n\n            return true;\n        },\n\n        /***\n         *\n         * @param {Boolean=} fast\n         */\n        show:function (fast) {\n\n            this._hidden = false;\n            if (fast) {\n                this._el.show();\n                this.resume();\n                this._onQueueEmpty();\n                return;\n            }\n\n            if (this._el.css('top') === 'auto' || !this._el.css('left') === 'auto') {\n                var left = $(window).width() * 0.8;\n                var top = ($(window).height() + $(document).scrollTop()) * 0.8;\n                this._el.css({top:top, left:left});\n            }\n\n            this.resume();\n            return this.play('Show');\n        },\n\n        /***\n         *\n         * @param {String} text\n         */\n        speak:function (text, hold) {\n            this._addToQueue(function (complete) {\n                this._balloon.speak(complete, text, hold);\n            }, this);\n        },\n\n\n        /***\n         * Close the current balloon\n         */\n        closeBalloon:function () {\n            this._balloon.hide();\n        },\n\n        delay:function (time) {\n            time = time || 250;\n\n            this._addToQueue(function (complete) {\n                this._onQueueEmpty();\n                window.setTimeout(complete, time);\n            });\n        },\n\n        /***\n         * Skips the current animation\n         */\n        stopCurrent:function () {\n            this._animator.exitAnimation();\n            this._balloon.close();\n        },\n\n\n        stop:function () {\n            // clear the queue\n            this._queue.clear();\n            this._animator.exitAnimation();\n            this._balloon.hide();\n        },\n\n        /***\n         *\n         * @param {String} name\n         * @returns {Boolean}\n         */\n        hasAnimation:function (name) {\n            return this._animator.hasAnimation(name);\n        },\n\n        /***\n         * Gets a list of animation names\n         *\n         * @return {Array.<string>}\n         */\n        animations:function () {\n            return this._animator.animations();\n        },\n\n        /***\n         * Play a random animation\n         * @return {jQuery.Deferred}\n         */\n        animate:function () {\n            var animations = this.animations();\n            var anim = animations[Math.floor(Math.random() * animations.length)];\n            // skip idle animations\n            if (anim.indexOf('Idle') === 0) {\n                return this.animate();\n            }\n            return this.play(anim);\n        },\n\n        /**************************** Utils ************************************/\n\n        /***\n         *\n         * @param {Number} x\n         * @param {Number} y\n         * @return {String}\n         * @private\n         */\n        _getDirection:function (x, y) {\n            var offset = this._el.offset();\n            var h = this._el.height();\n            var w = this._el.width();\n\n            var centerX = (offset.left + w / 2);\n            var centerY = (offset.top + h / 2);\n\n\n            var a = centerY - y;\n            var b = centerX - x;\n\n            var r = Math.round((180 * Math.atan2(a, b)) / Math.PI);\n\n            // Left and Right are for the character, not the screen :-/\n            if (-45 <= r && r < 45) return 'Right';\n            if (45 <= r && r < 135) return 'Up';\n            if (135 <= r && r <= 180 || -180 <= r && r < -135) return 'Left';\n            if (-135 <= r && r < -45) return 'Down';\n\n            // sanity check\n            return 'Top';\n        },\n\n        /**************************** Queue and Idle handling ************************************/\n\n        /***\n         * Handle empty queue.\n         * We need to transition the animation to an idle state\n         * @private\n         */\n        _onQueueEmpty:function () {\n            if (this._hidden || this._isIdleAnimation()) return;\n            var idleAnim = this._getIdleAnimation();\n            this._idleDfd = $.Deferred();\n\n            this._animator.showAnimation(idleAnim, $.proxy(this._onIdleComplete, this));\n        },\n\n        _onIdleComplete:function (name, state) {\n            if (state === clippy.Animator.States.EXITED) {\n                this._idleDfd.resolve();\n            }\n        },\n\n\n        /***\n         * Is the current animation is Idle?\n         * @return {Boolean}\n         * @private\n         */\n        _isIdleAnimation:function () {\n            var c = this._animator.currentAnimationName;\n            return c && c.indexOf('Idle') === 0;\n        },\n\n\n        /**\n         * Gets a random Idle animation\n         * @return {String}\n         * @private\n         */\n        _getIdleAnimation:function () {\n            var animations = this.animations();\n            var r = [];\n            for (var i = 0; i < animations.length; i++) {\n                var a = animations[i];\n                if (a.indexOf('Idle') === 0) {\n                    r.push(a);\n                }\n            }\n\n            // pick one\n            var idx = Math.floor(Math.random() * r.length);\n            return r[idx];\n        },\n\n        /**************************** Events ************************************/\n\n        _setupEvents:function () {\n            $(window).on('resize', $.proxy(this.reposition, this));\n\n            this._el.on('mousedown', $.proxy(this._onMouseDown, this));\n\n            this._el.on('dblclick', $.proxy(this._onDoubleClick, this));\n        },\n\n        _onDoubleClick:function () {\n            if (!this.play('ClickedOn')) {\n                this.animate();\n            }\n        },\n\n        reposition:function () {\n            if (!this._el.is(':visible')) return;\n            var o = this._el.offset();\n            var bH = this._el.outerHeight();\n            var bW = this._el.outerWidth();\n\n            var wW = $(window).width();\n            var wH = $(window).height();\n            var sT = $(window).scrollTop();\n            var sL = $(window).scrollLeft();\n\n            var top = o.top - sT;\n            var left = o.left - sL;\n            var m = 5;\n            if (top - m < 0) {\n                top = m;\n            } else if ((top + bH + m) > wH) {\n                top = wH - bH - m;\n            }\n\n            if (left - m < 0) {\n                left = m;\n            } else if (left + bW + m > wW) {\n                left = wW - bW - m;\n            }\n\n            this._el.css({left:left, top:top});\n            // reposition balloon\n            this._balloon.reposition();\n        },\n\n        _onMouseDown:function (e) {\n            e.preventDefault();\n            this._startDrag(e);\n        },\n\n\n        /**************************** Drag ************************************/\n\n        _startDrag:function (e) {\n            // pause animations\n            this.pause();\n            this._balloon.hide(true);\n            this._offset = this._calculateClickOffset(e);\n\n            this._moveHandle = $.proxy(this._dragMove, this);\n            this._upHandle = $.proxy(this._finishDrag, this);\n\n            $(window).on('mousemove', this._moveHandle);\n            $(window).on('mouseup', this._upHandle);\n\n            this._dragUpdateLoop = window.setTimeout($.proxy(this._updateLocation, this), 10);\n        },\n\n        _calculateClickOffset:function (e) {\n            var mouseX = e.pageX;\n            var mouseY = e.pageY;\n            var o = this._el.offset();\n            return {\n                top:mouseY - o.top,\n                left:mouseX - o.left\n            }\n\n        },\n\n        _updateLocation:function () {\n            this._el.css({top:this._targetY, left:this._taregtX});\n            this._dragUpdateLoop = window.setTimeout($.proxy(this._updateLocation, this), 10);\n        },\n\n        _dragMove:function (e) {\n            e.preventDefault();\n            var x = e.clientX - this._offset.left;\n            var y = e.clientY - this._offset.top;\n            this._taregtX = x;\n            this._targetY = y;\n        },\n\n        _finishDrag:function () {\n            window.clearTimeout(this._dragUpdateLoop);\n            // remove handles\n            $(window).off('mousemove', this._moveHandle);\n            $(window).off('mouseup', this._upHandle);\n            // resume animations\n            this._balloon.show();\n            this.reposition();\n            this.resume();\n\n        },\n\n        _addToQueue:function (func, scope) {\n            if (scope) func = $.proxy(func, scope);\n            this._queue.queue(func);\n        },\n\n        /**************************** Pause and Resume ************************************/\n\n        pause:function () {\n            this._animator.pause();\n            this._balloon.pause();\n\n        },\n\n        resume:function () {\n            this._animator.resume();\n            this._balloon.resume();\n        }\n\n    };\n\n    /******\n     *\n     *\n     * @constructor\n     */\n    clippy.Animator = function (el, path, data, sounds) {\n        this._el = el;\n        this._data = data;\n        this._path = path;\n        this._currentFrameIndex = 0;\n        this._currentFrame = undefined;\n        this._exiting = false;\n        this._currentAnimation = undefined;\n        this._endCallback = undefined;\n        this._started = false;\n        this._sounds = {};\n        this.currentAnimationName = undefined;\n        this.preloadSounds(sounds);\n        this._overlays = [this._el];\n        var curr = this._el;\n\n        this._setupElement(this._el);\n        for (var i = 1; i < this._data.overlayCount; i++) {\n            var inner = this._setupElement($('<div></div>'));\n\n            curr.append(inner);\n            this._overlays.push(inner);\n            curr = inner;\n        }\n    };\n\n    clippy.Animator.prototype = {\n        _setupElement:function (el) {\n            var frameSize = this._data.framesize;\n            el.css('display', \"none\");\n            el.css({width:frameSize[0], height:frameSize[1]});\n            el.css('background', \"url('\" + this._path + \"/map.png') no-repeat\");\n\n            return el;\n        },\n\n        animations:function () {\n            var r = [];\n            var d = this._data.animations;\n            for (var n in d) {\n                r.push(n);\n            }\n            return r;\n        },\n\n        preloadSounds:function (sounds) {\n\n            for (var i = 0; i < this._data.sounds.length; i++) {\n                var snd = this._data.sounds[i];\n                var uri = sounds[snd];\n                if (!uri) continue;\n                this._sounds[snd] = new Audio(uri);\n\n            }\n        },\n        hasAnimation:function (name) {\n            return !!this._data.animations[name];\n        },\n\n        exitAnimation:function () {\n            this._exiting = true;\n        },\n\n\n        showAnimation:function (animationName, stateChangeCallback) {\n            this._exiting = false;\n\n            if (!this.hasAnimation(animationName)) {\n                return false;\n            }\n\n            this._currentAnimation = this._data.animations[animationName];\n            this.currentAnimationName = animationName;\n\n\n            if (!this._started) {\n                this._step();\n                this._started = true;\n            }\n\n            this._currentFrameIndex = 0;\n            this._currentFrame = undefined;\n            this._endCallback = stateChangeCallback;\n\n            return true;\n        },\n\n\n        _draw:function () {\n            var images = [];\n            if (this._currentFrame) images = this._currentFrame.images || [];\n\n            for (var i = 0; i < this._overlays.length; i++) {\n                if (i < images.length) {\n                    var xy = images[i];\n                    var bg = -xy[0] + 'px ' + -xy[1] + 'px';\n                    this._overlays[i].css({'background-position':bg, 'display':'block'});\n                }\n                else {\n                    this._overlays[i].css('display', 'none');\n                }\n\n            }\n        },\n\n        _getNextAnimationFrame:function () {\n            if (!this._currentAnimation) return undefined;\n            // No current frame. start animation.\n            if (!this._currentFrame) return 0;\n            var currentFrame = this._currentFrame;\n            var branching = this._currentFrame.branching;\n\n\n            if (this._exiting && currentFrame.exitBranch !== undefined) {\n                return currentFrame.exitBranch;\n            }\n            else if (branching) {\n                var rnd = Math.random() * 100;\n                for (var i = 0; i < branching.branches.length; i++) {\n                    var branch = branching.branches[i];\n                    if (rnd <= branch.weight) {\n                        return branch.frameIndex;\n                    }\n\n                    rnd -= branch.weight;\n                }\n            }\n\n            return this._currentFrameIndex + 1;\n        },\n\n        _playSound:function () {\n            var s = this._currentFrame.sound;\n            if (!s) return;\n            var audio = this._sounds[s];\n            if (audio) audio.play();\n        },\n\n        _atLastFrame:function () {\n            return this._currentFrameIndex >= this._currentAnimation.frames.length - 1;\n        },\n\n        _step:function () {\n            if (!this._currentAnimation) return;\n            var newFrameIndex = Math.min(this._getNextAnimationFrame(), this._currentAnimation.frames.length - 1);\n            var frameChanged = !this._currentFrame || this._currentFrameIndex !== newFrameIndex;\n            this._currentFrameIndex = newFrameIndex;\n\n            // always switch frame data, unless we're at the last frame of an animation with a useExitBranching flag.\n            if (!(this._atLastFrame() && this._currentAnimation.useExitBranching)) {\n                this._currentFrame = this._currentAnimation.frames[this._currentFrameIndex];\n            }\n\n            this._draw();\n            this._playSound();\n\n            this._loop = window.setTimeout($.proxy(this._step, this), this._currentFrame.duration);\n\n\n            // fire events if the frames changed and we reached an end\n            if (this._endCallback && frameChanged && this._atLastFrame()) {\n                if (this._currentAnimation.useExitBranching && !this._exiting) {\n                    this._endCallback(this.currentAnimationName, clippy.Animator.States.WAITING);\n                }\n                else {\n                    this._endCallback(this.currentAnimationName, clippy.Animator.States.EXITED);\n                }\n            }\n        },\n\n        /***\n         * Pause animation execution\n         */\n        pause:function () {\n            window.clearTimeout(this._loop);\n        },\n\n        /***\n         * Resume animation\n         */\n        resume:function () {\n            this._step();\n        }\n    };\n\n    clippy.Animator.States = { WAITING:1, EXITED:0 };\n\n    /******\n     *\n     *\n     * @constructor\n     */\n    clippy.Balloon = function (targetEl) {\n        this._targetEl = targetEl;\n\n        this._hidden = true;\n        this._setup();\n    };\n\n    clippy.Balloon.prototype = {\n\n        WORD_SPEAK_TIME:320,\n        CLOSE_BALLOON_DELAY:2000,\n\n        _setup:function () {\n\n            this._balloon = $('<div class=\"clippy-balloon\"><div class=\"clippy-tip\"></div><div class=\"clippy-content\"></div></div> ').hide();\n            this._content = this._balloon.find('.clippy-content');\n\n            $(document.body).append(this._balloon);\n        },\n\n        reposition:function () {\n            var sides = ['top-left', 'top-right', 'bottom-left', 'bottom-right'];\n\n            for (var i = 0; i < sides.length; i++) {\n                var s = sides[i];\n                this._position(s);\n                if (!this._isOut()) break;\n            }\n        },\n\n        _BALLOON_MARGIN:15,\n\n        /***\n         *\n         * @param side\n         * @private\n         */\n        _position:function (side) {\n            var o = this._targetEl.offset();\n            var h = this._targetEl.height();\n            var w = this._targetEl.width();\n\n            var bH = this._balloon.outerHeight();\n            var bW = this._balloon.outerWidth();\n\n            this._balloon.removeClass('clippy-top-left');\n            this._balloon.removeClass('clippy-top-right');\n            this._balloon.removeClass('clippy-bottom-right');\n            this._balloon.removeClass('clippy-bottom-left');\n\n            var left, top;\n            switch (side) {\n                case 'top-left':\n                    // right side of the balloon next to the right side of the agent\n                    left = o.left + w - bW;\n                    top = o.top - bH - this._BALLOON_MARGIN;\n                    break;\n                case 'top-right':\n                    // left side of the balloon next to the left side of the agent\n                    left = o.left;\n                    top = o.top - bH - this._BALLOON_MARGIN;\n                    break;\n                case 'bottom-right':\n                    // right side of the balloon next to the right side of the agent\n                    left = o.left;\n                    top = o.top + h + this._BALLOON_MARGIN;\n                    break;\n                case 'bottom-left':\n                    // left side of the balloon next to the left side of the agent\n                    left = o.left + w - bW;\n                    top = o.top + h + this._BALLOON_MARGIN;\n                    break;\n            }\n\n            this._balloon.css({top:top, left:left});\n            this._balloon.addClass('clippy-' + side);\n        },\n\n        _isOut:function () {\n            var o = this._balloon.offset();\n            var bH = this._balloon.outerHeight();\n            var bW = this._balloon.outerWidth();\n\n            var wW = $(window).width();\n            var wH = $(window).height();\n            var sT = $(document).scrollTop();\n            var sL = $(document).scrollLeft();\n\n            var top = o.top - sT;\n            var left = o.left - sL;\n            var m = 5;\n            if (top - m < 0 || left - m < 0) return true;\n            if ((top + bH + m) > wH || (left + bW + m) > wW) return true;\n\n            return false;\n        },\n\n        speak:function (complete, text, hold) {\n            this._hidden = false;\n            this.show();\n            var c = this._content;\n            // set height to auto\n            c.height('auto');\n            c.width('auto');\n            // add the text\n            c.text(text);\n            // set height\n            c.height(c.height());\n            c.width(c.width());\n            c.text('');\n            this.reposition();\n\n            this._complete = complete;\n            this._sayWords(text, hold, complete);\n        },\n\n        show:function () {\n            if (this._hidden) return;\n            this._balloon.show();\n        },\n\n        hide:function (fast) {\n            if (fast) {\n                this._balloon.hide();\n                return;\n            }\n\n            this._hiding = window.setTimeout($.proxy(this._finishHideBalloon, this), this.CLOSE_BALLOON_DELAY);\n        },\n\n        _finishHideBalloon:function () {\n            if (this._active) return;\n            this._balloon.hide();\n            this._hidden = true;\n            this._hiding = null;\n        },\n\n        _sayWords:function (text, hold, complete) {\n            this._active = true;\n            this._hold = hold;\n            var words = text.split(/[^\\S-]/);\n            var time = this.WORD_SPEAK_TIME;\n            var el = this._content;\n            var idx = 1;\n\n\n            this._addWord = $.proxy(function () {\n                if (!this._active) return;\n                if (idx > words.length) {\n                    this._active = false;\n                    if (!this._hold) {\n                        complete();\n                        this.hide();\n                    }\n                } else {\n                    el.text(words.slice(0, idx).join(' '));\n                    idx++;\n                    this._loop = window.setTimeout($.proxy(this._addWord, this), time);\n                }\n            }, this);\n\n            this._addWord();\n\n        },\n\n        close:function () {\n            if (this._active) {\n                this._hold = false;\n            } else if (this._hold) {\n                this._complete();\n            }\n        },\n\n        pause:function () {\n            window.clearTimeout(this._loop);\n            if (this._hiding) {\n                window.clearTimeout(this._hiding);\n                this._hiding = null;\n            }\n        },\n\n        resume:function () {\n            if (this._addWord)  this._addWord();\n            this._hiding = window.setTimeout($.proxy(this._finishHideBalloon, this), this.CLOSE_BALLOON_DELAY);\n        }\n\n\n    };\n\n    clippy.BASE_PATH = '//s3.amazonaws.com/clippy.js/Agents/';\n\n    clippy.load = function (name, successCb, failCb) {\n        var path = clippy.BASE_PATH + name;\n\n        var mapDfd = clippy.load._loadMap(path);\n        var agentDfd = clippy.load._loadAgent(name, path);\n        var soundsDfd = clippy.load._loadSounds(name, path);\n\n        var data;\n        agentDfd.done(function (d) {\n            data = d;\n        });\n\n        var sounds;\n\n        soundsDfd.done(function (d) {\n            sounds = d;\n        });\n\n        // wrapper to the success callback\n        var cb = function () {\n            var a = new clippy.Agent(path, data,sounds);\n            successCb(a);\n        };\n\n        $.when(mapDfd, agentDfd, soundsDfd).done(cb).fail(failCb);\n    };\n\n    clippy.load._maps = {};\n    clippy.load._loadMap = function (path) {\n        var dfd = clippy.load._maps[path];\n        if (dfd) return dfd;\n\n        // set dfd if not defined\n        dfd = clippy.load._maps[path] = $.Deferred();\n\n        var src = path + '/map.png';\n        var img = new Image();\n\n        img.onload = dfd.resolve;\n        img.onerror = dfd.reject;\n\n        // start loading the map;\n        img.setAttribute('src', src);\n\n        return dfd.promise();\n    };\n\n    clippy.load._sounds = {};\n\n    clippy.load._loadSounds = function (name, path) {\n        var dfd = clippy.load._sounds[name];\n        if (dfd) return dfd;\n\n        // set dfd if not defined\n        dfd = clippy.load._sounds[name] = $.Deferred();\n\n        var audio = document.createElement('audio');\n        var canPlayMp3 = !!audio.canPlayType && \"\" != audio.canPlayType('audio/mpeg');\n        var canPlayOgg = !!audio.canPlayType && \"\" != audio.canPlayType('audio/ogg; codecs=\"vorbis\"');\n\n        if (!canPlayMp3 && !canPlayOgg) {\n            dfd.resolve({});\n        } else {\n            var src = path + (canPlayMp3 ? '/sounds-mp3.js' : '/sounds-ogg.js');\n            // load\n            clippy.load._loadScript(src);\n        }\n\n        return dfd.promise()\n    };\n\n\n    clippy.load._data = {};\n    clippy.load._loadAgent = function (name, path) {\n        var dfd = clippy.load._data[name];\n        if (dfd) return dfd;\n\n        dfd = clippy.load._getAgentDfd(name);\n\n        var src = path + '/agent.js';\n\n        clippy.load._loadScript(src);\n\n        return dfd.promise();\n    };\n\n    clippy.load._loadScript = function (src) {\n        var script = document.createElement('script');\n        script.setAttribute('src', src);\n        script.setAttribute('async', 'async');\n        script.setAttribute('type', 'text/javascript');\n\n        document.head.appendChild(script);\n    };\n\n    clippy.load._getAgentDfd = function (name) {\n        var dfd = clippy.load._data[name];\n        if (!dfd) {\n            dfd = clippy.load._data[name] = $.Deferred();\n        }\n        return dfd;\n    };\n\n    clippy.ready = function (name, data) {\n        var dfd = clippy.load._getAgentDfd(name);\n        dfd.resolve(data);\n    };\n\n    clippy.soundsReady = function (name, data) {\n        var dfd = clippy.load._sounds[name];\n        if (!dfd) {\n            dfd = clippy.load._sounds[name] = $.Deferred();\n        }\n\n        dfd.resolve(data);\n    };\n\n    /******\n     * Tiny Queue\n     *\n     * @constructor\n     */\n    clippy.Queue = function (onEmptyCallback) {\n        this._queue = [];\n        this._onEmptyCallback = onEmptyCallback;\n    };\n\n    clippy.Queue.prototype = {\n        /***\n         *\n         * @param {function(Function)} func\n         * @returns {jQuery.Deferred}\n         */\n        queue:function (func) {\n            this._queue.push(func);\n\n            if (this._queue.length === 1 && !this._active) {\n                this._progressQueue();\n            }\n        },\n\n        _progressQueue:function () {\n\n            // stop if nothing left in queue\n            if (!this._queue.length) {\n                this._onEmptyCallback();\n                return;\n            }\n\n            var f = this._queue.shift();\n            this._active = true;\n\n            // execute function\n            var completeFunction = $.proxy(this.next, this);\n            f(completeFunction);\n        },\n\n        clear:function () {\n            this._queue = [];\n        },\n\n        next:function () {\n            this._active = false;\n            this._progressQueue();\n        }\n    };\n\n}.call(this));"]}